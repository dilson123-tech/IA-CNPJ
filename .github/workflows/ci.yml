name: CI

on:
  pull_request:
  push:
    branches: [main]
  workflow_dispatch:
permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-22.04
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: |
            backend/requirements.txt
            backend/requirements-dev.txt

      - name: Install deps
        run: |
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Ruff
        run: ruff check .

      - name: Py compile
        run: python -m compileall -q .
      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Shell scripts (bash -n + shellcheck)
        shell: bash
        run: |
          set -euo pipefail
          find scripts -type f -name '*.sh' -print0 | xargs -0 -r -n1 bash -n
          find scripts -type f -name '*.sh' -print0 | xargs -0 -r shellcheck -x -S error

  settings_contract:
    runs-on: ubuntu-22.04
    needs: lint
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: |
            backend/requirements.txt
            backend/requirements-dev.txt

      - name: Install deps
        run: |
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Settings contract (auth invariants)
        shell: bash
        env:
          DATABASE_URL: sqlite:////tmp/ia_cnpj_contract.db
        run: |
          set -euo pipefail

          fail_msg() { echo "❌ $1"; shift; printf '%s\n' "$@" >&2; exit 1; }

          expect_fail_grep() {
            local name="$1" pat="$2"; shift 2
            local out; out="$(mktemp)"
            if "$@" >"$out" 2>&1; then
              cat "$out"; rm -f "$out"
              fail_msg "era pra FALHAR: $name"
            fi
            if ! grep -qE "$pat" "$out"; then
              cat "$out"; rm -f "$out"
              fail_msg "falhou, mas não bateu o motivo esperado: $name" "pattern=$pat"
            fi
            echo "✅ expected FAIL: $name"
            rm -f "$out"
          }

          expect_pass() {
            local name="$1"; shift
            local out; out="$(mktemp)"
            if ! "$@" >"$out" 2>&1; then
              cat "$out"; rm -f "$out"
              fail_msg "era pra PASSAR: $name"
            fi
            echo "✅ expected PASS: $name"
            rm -f "$out"
          }

          # 1) ENV=prod exige AUTH_ENABLED=true
          expect_fail_grep "prod requires auth" "ENV=prod requer AUTH_ENABLED=true"             env IA_CNPJ_ENV=prod IA_CNPJ_AUTH_ENABLED=false python -c "import app.main"

          # 2) AUTH_PROTECT_DOCS não pode existir sem AUTH_ENABLED
          expect_fail_grep "protect_docs requires auth" "AUTH_PROTECT_DOCS|AUTH_ENABLED"             env IA_CNPJ_ENV=lab IA_CNPJ_AUTH_ENABLED=false IA_CNPJ_AUTH_PROTECT_DOCS=true python -c "import app.main"

          # 3) AUTH_ENABLED=true exige AUTH_JWT_SECRET preenchido
          expect_fail_grep "jwt secret required" "AUTH_JWT_SECRET vazio"             env IA_CNPJ_ENV=lab IA_CNPJ_AUTH_ENABLED=true IA_CNPJ_AUTH_USERNAME=admin IA_CNPJ_AUTH_PASSWORD=Aurea@12345 IA_CNPJ_AUTH_JWT_SECRET= python -c "import app.main"

          # 4) happy path
          expect_pass "happy path import"             env IA_CNPJ_ENV=prod IA_CNPJ_AUTH_ENABLED=true IA_CNPJ_AUTH_PROTECT_DOCS=true IA_CNPJ_AUTH_USERNAME=admin IA_CNPJ_AUTH_PASSWORD=Aurea@12345                 IA_CNPJ_AUTH_JWT_SECRET=0123456789abcdef0123456789abcdef                 python -c "import app.main; print('IMPORT OK ✅')"


  smoke:
    runs-on: ubuntu-22.04
    needs: [lint, settings_contract]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: |
            backend/requirements.txt
            backend/requirements-dev.txt

      - name: Install deps (smoke job)
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt -r backend/requirements-dev.txt

      - name: Smoke (uvicorn + scripts/smoke.sh)
        env:
          DATABASE_URL: sqlite:////tmp/ia_cnpj_ci.db
          IA_CNPJ_ENV: lab
          IA_CNPJ_AUTH_ENABLED: "true"
          IA_CNPJ_AUTH_JWT_SECRET: 0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef
          IA_CNPJ_AUTH_USERNAME: admin
          IA_CNPJ_AUTH_PASSWORD: Aurea@12345
          SMOKE_AUTH_USER: admin
          SMOKE_AUTH_PASS: Aurea@12345
        shell: bash
        run: |
          set -euo pipefail
          set -o xtrace
          export SHELLOPTS

          # sanity: bash filho herda xtrace via SHELLOPTS
          bash --noprofile --norc -c '[[ $- == *x* ]] && echo "xtrace inherited ✅"'

          # init DB (CI): aplica migrations se Alembic existir
    if command -v alembic >/dev/null 2>&1 && { [ -f backend/alembic.ini ] || [ -d backend/alembic ]; }; then
      (cd backend && alembic upgrade head)
    else
      echo "ℹ️ CI: alembic não encontrado (ou sem config) — pulando migrations"
    fi

    # sobe API (background) no mesmo job/env
          (cd backend && python -m uvicorn app.main:app --host 127.0.0.1 --port 8100) > /tmp/ci_api.log 2>&1 &
          API_PID=$!
          trap 'kill "$API_PID" || true' EXIT

          # espera /health (determinístico)
          python - <<'PY_WAIT'
          import time, urllib.request
          base='http://127.0.0.1:8100'
          for i in range(45):
              try:
                  with urllib.request.urlopen(base + '/health', timeout=2) as r:
                      if r.status == 200:
                          print('api up ✅')
                          break
              except Exception:
                  time.sleep(1)
          else:
              raise SystemExit('FAIL: API não subiu em /health')
          PY_WAIT

          # roda smoke real (Master2)
          set +e
    (cd backend && BASE="http://127.0.0.1:8100" bash scripts/smoke.sh) |& tee /tmp/ci_smoke.log
    rc=${PIPESTATUS[0]}
    set -e
    if [ "$rc" -ne 0 ]; then
      echo "== /tmp/ci_api.log (tail) =="
      tail -n 200 /tmp/ci_api.log || true
      echo "== /tmp/ci_smoke.log (tail) =="
      tail -n 200 /tmp/ci_smoke.log || true
      exit "$rc"
    fi

          # segurança: NÃO pode vazar header Authorization nem JWT (prefixo eyJhbGci)
          if grep -nE 'Authorization: Bearer|eyJhbGci' /tmp/ci_smoke.log /tmp/ci_api.log; then
            echo '❌ SECURITY: token vazou no log sob xtrace'
            exit 1
          fi

          echo '✅ OK: não vazou token sob xtrace'
